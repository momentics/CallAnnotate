# Директория /volume

В контейнере CallAnnotate всё хранится во внешнем смонтированном томе `/`. Ниже описана актуальная структура и назначение каталогов.

## Структура каталогов

```

/volume
├── incoming/                 \# Новые поступившие аудиофайлы для обработки
├── processing/               \# Аудиофайлы, находящиеся в процессе обработки
├── completed/                \# Успешно обработанные файлы и JSON-отчёты
├── failed/                   \# Аудиофайлы, обработка которых завершилась ошибкой
├── archived/                 \# Архив старых задач и результатов
├── logs/
│   └── system/
│       └── app.log           \# Основной лог-файл приложения
├── models/
│   └── embeddings/
│       ├── *.vec             \# Эмбеддинги известных спикеров (.vec-файлы)
├── temp/                     \# Временные файлы и промежуточные данные
└── README.md                 \# Этот файл

```

---

## Назначение разделов

### 1. incoming  
Папка для вновь загруженных аудиофайлов. Клиент копирует сюда файл (через REST-запрос или напрямую), после чего QueueManager регистрирует задачу.

### 2. processing  
Во время обработки аудиофайлы (или их чанки) переносятся из `incoming` в `processing`. Здесь они находятся до завершения всех этапов обработки.

### 3. completed  
После успешной обработки:
- Исходный аудиофайл остаётся в `completed/`.
- Автоматически генерируемые JSON-отчёты (диаризация, транскрипция, распознавание, и т.д.) сохраняются рядом с файлом.

### 4. failed  
Если на любом этапе обработки произошла ошибка, файл переносится в `failed/`. Рядом может появиться JSON с полем `error` для отладки и повторной обработки.

### 5. archived  
Автоматически (по политике хранения) через 7 дней после завершения задачи файлы из `completed` и `failed` перемещаются в `archived/`. Это освобождает место и сохраняет историю.

### 6. logs/system  
Содержит основной лог приложения `app.log`. Настройки ротации и уровня логирования задаются в `config/default.yaml`. Формат примера:
```

2025-07-28T02:00:00Z - callannotate - INFO - job_started - job_id=550e8400-e29b-41d4-a716-446655440000

```

### 7. models/embeddings  
Папка для `.vec`-файлов с эмбеддингами голосов известных спикеров. Используется модулем распознавания (`recognition.py`).  
Пример:
```

models/embeddings/ivan_petrov.vec
models/embeddings/maria_sidorova.vec

```

### 8. temp  
(Опционально) Временные файлы и промежуточные результаты (чанки аудио, временные транскрипты).  
Параметры автоматической очистки задаются в `config/default.yaml`:
```

files:
temp_cleanup_hours: 24

```

---

## Политика хранения и очистки

- **Очистка промежуточных данных** выполняется каждые `cleanup_interval` секунд (по умолчанию 300 с) в QueueManager.
- **Удаление временных файлов** старше `temp_cleanup_hours` (по умолчанию 24 ч).
- **Архивация** завершённых (`completed`) и неудачных (`failed`) задач через 7 дней.
- Все параметры настраиваются в `config/default.yaml` в разделе `queue` и `files`.

---

## Права доступа

Рекомендуемые права доступа к папкам (на уровне хоста или в Docker-volume):

| Каталог               | Владелец приложения | Администратор |
|-----------------------|---------------------|---------------|
| `/volume/incoming`    | rwx                 | —             |
| `/volume/processing`  | rwx                 | —             |
| `/volume/completed`   | rwx                 | —             |
| `/volume/failed`      | rwx                 | —             |
| `/volume/archived`    | rwx                 | —             |
| `/volume/logs/system` | rw                  | r             |
| `/volume/models`      | r                   | —             |
| `/volume/temp`        | rwx                 | —             |

---

## Пример Docker Compose

```

services:
callannotate:
volumes:
- ./volume:/volume
environment:
- VOLUME_PATH=/volume

```

После старта контейнера проверьте доступность `/health` перед загрузкой задач.

---
