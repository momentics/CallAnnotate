# Директория `/volume`

В папке `/volume` хранятся файлы и данные, используемые приложением CallAnnotate очередей задач, промежуточных и итоговых результатов, логирования и моделей. Ниже приведена актуальная структура и описание каждого элемента.

## Структура каталогов

```

/volume
├── incoming/                 \# Новые поступившие аудиофайлы для обработки
├── processing/               \# Аудиофайлы, находящиеся в процессе обработки
├── completed/                \# Успешно обработанные файлы и JSON-отчёты
├── failed/                   \# Аудиофайлы, обработка которых завершилась ошибкой
├── archived/                 \# Архив старых задач и результатов
├── logs/
│   └── system/
│       └── app.log           \# Основной лог-файл приложения
├── models/
│   └── embeddings/
│       ├── ivan_petrov.vec   \# Эмбеддинг “Иван Петров”
│       └── maria_sidorova.vec\# Эмбеддинг “Мария Сидорова”
└── temp/                     \# (опционально) Временные файлы транскрипции и промежуточные данные

```

## Описание разделов

### incoming  
Папка для вновь загруженных аудиофайлов. Каждая задача (файл) сначала попадает сюда и ждёт своей очереди.

### processing  
Во время обработки аудиофайлы и их куски (_chunks_) хранятся здесь. После завершения задачи файл перемещается в `completed/` или `failed/`.

### completed  
Содержит:
- оригинальный аудиофайл;
- автоматически сгенерированные JSON-отчёты с транскрипцией, диаризацией, распознаванием голосов и другими аннотациями.

### failed  
Содержит файлы и метаданные задач, при обработке которых произошла ошибка. Используется для последующего анализа и повторной обработки.

### archived  
Хранит результаты и логи старых задач, перенесённые автоматически по политике хранения (см. `config/default.yaml`).

### logs/system/app.log  
Файл логов уровня INFO и выше. Путь, формат и ротация логов настраиваются в `config/default.yaml`:
```

logging:
file: "./volume/logs/system/app.log"
level: "INFO"
format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

```

### models/embeddings  
Папка с векторными представлениями голосов известных говорящих. Файлы в формате `.vec` нужны для модуля распознавания голосов (`recognition.py`).

### temp  
(Опционально) Временные файлы и промежуточные данные (например, нарезанные чанки аудио, временные файлы транскрипции). Очищается автоматически через `temp_cleanup_hours` в конфиге.

## Политика хранения и очистки

Все параметры задаются в `config/default.yaml`:

```

files:
max_size: 524288000        \# допустимый максимальный размер файла (500 MB)
temp_cleanup_hours: 24     \# удаление временных файлов старше 24 ч
queue:
cleanup_interval: 300      \# интервал проверки очереди (сек)

```

- **Очередь задач**: каждые 5 минут (`cleanup_interval`) проверяется состояние очереди и очищаются устаревшие временные данные.
- **Временные файлы**: удаляются через 24 ч после создания.

## Использование с Docker Compose

В `docker/docker-compose.yml` для сервиса CallAnnotate настроен `healthcheck`:

```

services:
callannotate:
healthcheck:
test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
interval: 10s
timeout: 5s
retries: 5

```

- После поднятия контейнера CI ожидает статус `healthy` на REST-эндпоинте `/health` перед запуском тестов WebSocket и REST.

## Настройка прав доступа

Рекомендуется:
- `incoming/`, `processing/`, `completed/`, `failed/`, `archived/` — права `rwx` для пользователя приложения.
- `logs/system/` — `rw` для приложения, `r` для администратора.
- `models/embeddings/` — `r` для приложения.

Права задаются на уровне ОС или через Docker-volume.

---

**Версия:** 2025-07-27  
**Источник конфигурации:** `config/default.yaml`  

```
queue:
volume_path: "./volume"
files:
temp_cleanup_hours: 24
logging:
file: "./volume/logs/system/app.log"
```
