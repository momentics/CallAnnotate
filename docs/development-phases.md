# План фаз разработки CallAnnotate

Файл: `docs/development-phases.md`  

CallAnnotate — модульная система автоматической аннотации аудиозаписей. Каждая фаза — небольшая, измеримая итерация с чётким набором задач, критериев успешности и ожидаемых артефактов.

---

## **Phase 1: REST API и файловая очередь**  
   _Статус: выполнено_  
   - **Задачи:**  
     - Реализовать FastAPI-эндпоинты `/health`, `/info`, `/jobs`  
     - Организовать файловую очередь: папки `incoming`, `processing`, `completed`, `failed`, `archived`  
     - Асинхронная фоновая обработка одного файла через `QueueManager`  
     - Dockerfile + `docker-compose.ystages`  
     - Unit-тесты (coverage ≥ 80 %)  
     - CI (GitHub Actions)  
   - **Критерии готовности:** все тесты зелёные, файлы переходят по состояниям, `/health` и `/info` возвращают корректный JSON.

---

## **Phase 2: WebSocket и real-time уведомления**  
   _Статус: выполнено_  
   - **Задачи:**  
     - Эндпоинт `/ws/{client_id}` для JSON-сообщений  
     - Heartbeat (ping/pong), автоматическое переподключение  
     - Backpressure: ограничить размер сообщений (по умолчанию 1 MB)  
     - Интеграционные тесты WebSocket  
     - Обновить CI для запуска WebSocket-тестов  
   - **Критерии готовности:** соединение устойчивое, переполнение закрывает соединение с кодом 1009, тесты зелёные.

---

## **Phase 3: Интерфейс stages модулей и конфигурация**  
   _Статус: выполнено_  
   - **Задачи:**  
     1. Создать файл `src/app/stages/base.py`, абстрактный класс `BaseStage`.  
     2. Описать конфигурацию моделей в `config/default.yaml` (путь, параметры).  
     3. Реализовать заглушки (mocks) для всех stages-модулей.  
     4. Unit-тесты интерфейса (coverage ≥ 90 %).  
   - **Критерии готовности:** класс и конфиг работают, mocks возвращают предсказуемый результат, тесты зелёные.

---

## **Phase 4: Предобработка аудио**  
   _Статус: выполнено_  
   - **Задачи:**  
     1. `src/app/stages/preprocessing.py`: нормализация уровня громкости, удаление шума (например, через sox, улучшение речи).  
     2. Unit-тесты обработки на контрольных WAV-файлах.  
     3. Интеграция с `QueueManager`: вызвать preprocessing перед остальными этапами.  
   - **Критерии готовности:** предобработка применяет фильтры, тесты проверяют характеристики аудио.

---

## **Phase 5: Диаризация спикеров**  
   _Статус: выполнено_  
   - **Задачи:**  
     1. `src/app/stages/diarization.py`: интеграция библиотеки pyannote/speaker-diarization.  
     2. Unit-тесты сегментации: проверка временных меток на небольших записях.  
     3. Интеграция в pipeline: preprocessing → diarization.  
   - **Критерии готовности:** сегменты спикеров корректны, тесты зелёные.

---

## **Phase 6: Batch-ASR (Whisper)**  
   - **Задачи:**  
     1. `src/app/stages/transcription.py`: обёртка над OpenAI Whisper для пакетной обработки.  
     2. Unit-тесты на коротких аудиофайлах: проверка наличия текста.  
     3. Интеграция в pipeline: preprocessing → diarization → transcription.  
   - **Критерии готовности:** транскрипция возвращает текст для тестовых файлов, тесты зелёные.

---

## **Phase 8: Speaker Recognition**  
   - **Задачи:**  
     1. `src/app/stages/recognition.py`: интеграция ECAPA-TDNN (speechbrain) для сравнения эмбеддингов.  
     2. CRUD-REST-эндпоинты для управления «известными» голосами и загрузки эмбеддингов.  
     3. Unit-тесты точности распознавания (precision ≥ 85 % на контрольном наборе).  
   - **Критерии готовности:** API возвращает идентификатор спикера или `unknown`, тесты зелёные.

---

## **Phase 9: Интеграция CardDAV-контактов**  
   - **Задачи:**  
     1. `src/app/stages/carddav_client.py`: асинхронный клиент с кэшированием и fallback.  
     2. REST-эндпоинты CRUD для контактов.  
     3. Интеграционные тесты с мок-сервером (pytest-aioresponses).  
   - **Критерии готовности:** контакты успешно синхронизируются, CRUD-операции работают, тесты зелёные.

---

## **Phase 10: Клиентские SDK и примеры**  
    - **Задачи:**  
      1. Генерация SDK на Python/JavaScript из OpenAPI.  
      2. Примеры использования (upload, subscribe, fetch result).  
      3. Документация “Getting Started” для SDK.  
    - **Критерии готовности:** SDK устанавливаются из PyPI/npm, примеры работают, документация проверена.

---

## **Phase 11: Production-ready CI/CD и контейнеризация**  
    - **Задачи:**  
      1. Кросс-платформенные Docker-образы (amd64, arm64).  
      2. Security scan зависимостей (Trivy, Dependabot).  
      3. Helm-charts для Kubernetes и документация по развёртыванию.  
      4. Performance- и load-тестирование в CI (coverage ≥ 90 %).  
      5. Автоматический rollback при неудачах.  
    - **Критерии готовности:** CI проходит все шаги, образы готовы к деплою, документация завершена.

---

