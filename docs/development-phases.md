# План фаз разработки CallAnnotate

Файл: `docs/development-phases.md`  
Версия: 1.0  
Дата: 27 июля 2025  

---

## Обзор проекта

CallAnnotate — модульная система для автоматической аннотации аудиозаписей: от загрузки через REST/WebSocket до диаризации, транскрипции и распознавания говорящих. Разработка идёт итерациями (Phase), каждая фаза добавляет измеримый набор возможностей.

---

## Описание фаз (Phase) проекта

---

### Phase 1: Базовый REST API и файловая очередь
**Цель:** Базовый сервер и очередь задач  
**Выполнено:**
- FastAPI-сервер с `/health`, `/info`, `/jobs`  
- Файловая очередь (`incoming→processing→completed→failed→archived`)  
- Асинхронная фоноваая обработка через `QueueManager`  
- Unit-тесты (`tests/test_app_endpoints.py`) и CI/CD (`.github/workflows/ci.yml`)  
- Docker-контейнеризация  

---

### Phase 2: WebSocket и real-time обработка
**Цель:** Реального времени уведомления  
**Выполнено:**
- WebSocket эндпоинт `/ws/{client_id}`  
- Heartbeat (ping/pong), переподключение, контроль backpressure  
- Интеграционные тесты (`tests/test_websocket_integration.py`)  
- Документация WebSocket-API в `docs/api-specification.md`  

---

### Phase 3: Архитектура ML-модулей  
**Цель:** Построить каркас для всех ML-компонентов.  
**Задачи:**
- Создать пакет `src/ml` с базовым классом `MLProcessor` (методы `load_model()`, `process()`, `cleanup()`).
- Определить единый интерфейс для всех ML-процессоров.
- Конфигурирование моделей через `config/models.yaml`.
- Разработать простые «заглушки» (mocks) для тестирования.

---

### Phase 4: Диаризация и предобработка аудио  
**Цель:** Внедрить модуль диаризации и аудио-препроцессинг.  
**Задачи:**
- Реализовать `src/ml/diarization.py` (интеграция pyannote/speaker-diarization).
- `src/ml/preprocessing.py`: нормализация уровня, удаление шума.
- Unit-тесты для проверок корректности сегментации и предобработки.
- Обновить `QueueManager` для запуска этих шагов перед основной обработкой.

---

### Phase 5: Транскрипция и потоковая обработка  
**Цель:** Привести в строй ASR-модуль и поддержку потоковой транскрипции.  
**Задачи:**
- Реализовать `src/ml/transcription.py` для Whisper и Whisper Streaming API.
- В модуле разбить аудио на чанки, обрабатывать в режиме low-latency.
- Интегрировать WebSocket-канал для отправки промежуточных результатов.
- Покрыть модуль unit-тестами.

---

### Phase 6: Распознавание говорящих (Speaker Recognition)  
**Цель:** Сравнение эмбеддингов голосов в офлайн-режиме.  
**Задачи:**
- Расширить `src/ml/recognition.py` для ECAPA-TDNN.
- Настроить хранение и загрузку эмбеддингов из `models/embeddings`.
- Few-shot механизм добавления новых голосов (через REST-API).
- Юнит-тесты точности ≥ 85 %.

---

### Phase 7: Интеграция CardDAV и управление контактами  
**Цель:** Связывание распознанных голосов с контактами.  
**Задачи:**
- Реализовать `src/contacts/carddav_client.py` с кэшированием и fallback.
- Разработать REST-эндпоинты для CRUD операций с контактами.
- Стратегии разрешения конфликтов (по номеру, по имени).
- Интеграционные тесты с настоящим/мокнутым CardDAV-сервером.

---

### Phase 8: Оркестрация и масштабирование  
**Цель:** Вывести ML-задачи в отдельные воркеры, добавить отказоустойчивость.  
**Задачи:**
- Подключить Redis-брокер для очереди задач.
- Ввести Celery/ProcessPoolExecutor для выполнения `MLProcessor` в воркерах.
- Реализовать retry-механизмы и circuit breaker.
- Мониторинг состояния воркеров и очередей.

---

### Phase 9: Расширенная аннотация и отчёты  
**Цель:** Сбор всех результатов в единый отчёт и экспорт.  
**Задачи:**
- `src/annotation/annotation_service.py`: объединение диаризации, транскрипции, распознавания.
- Word-level таймлайн, анализ тональности и эмоций.
- Экспорт отчётов в JSON, CSV, HTML и PDF.
- UI-шаблоны для просмотра отчётов (пример).

---

### Phase 10: Безопасность и авторизация  
**Цель:** Защитить API и WebSocket, ввести разграничение доступа.  
**Задачи:**
- JWT + OAuth2 + RBAC (роли admin/user).
- Rate limiting для REST и WebSocket (token bucket).
- Audit-логи запросов и действий.
- Шифрование данных at-rest (volume) и in-transit.

---

### Phase 11: Мониторинг, логирование и оповещения  
**Цель:** Внедрить сбор метрик и алерты на продакшене.  
**Задачи:**
- Интеграция с Prometheus (metrics endpoint) и Grafana (дашборды).
- Расширенное логирование (ELK-stack форматы).
- Webhook/Email-оповещения о критических сбоях и SLA-нарушениях.
- Healthchecks для всех сервисов (REST, WS, workers).

---

### Phase 12: Production-ready CI/CD и контейнеризация  
**Цель:** Довести до полноценного промышленного деплоя.  
**Задачи:**
- Полные end-to-end тесты в Docker Compose (REST + WS + workers).
- Кросс-платформенные Docker-образы (amd64, arm64).
- Security scan зависимостей (Trivy, Dependabot).
- Helm-charts для Kubernetes и документация по развёртыванию.
- Performance testing (load tests) в CI, покрытие тестами ≥ 90 %.

---
